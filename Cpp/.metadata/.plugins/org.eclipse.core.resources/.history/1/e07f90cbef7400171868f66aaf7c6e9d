/*
 * Database.cpp
 *
 *  Created on: 28 de jul de 2017
 *      Author: anderson
 */

#include "Database.h"

Database::Database(std::string databaseFile)
{
	if (sqlite3_open(databaseFile.c_str(), &m_db) != SQLITE_OK)
	{
		error_cant_open();
	}
}

Database::~Database()
{
	sqlite3_close(m_db);
}

int Database::query(std::string sql_query, std::list<std::string>& out_values)
{
	//database handler
	sqlite3_stmt *res;

	//create SQL statement definition
	if (sqlite3_prepare_v2(m_db, sql_query.c_str(), -1, &res, 0) != SQLITE_OK)
	{
		error_failed_to_fetch();
	}

	//capture values until the table finishes
	while (true)
	{
		if (sqlite3_step(res) != SQLITE_ROW)
		{
			break;
		}
		out_values.push_back((const char*) sqlite3_column_text(res, 0));
	}

	sqlite3_finalize(res);
	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::get(std::string table, std::string thecolumn,
		std::list<std::string>& out_values)
{
	std::string sql_query = "SELECT " + thecolumn + " FROM " + table + ";";

	query(sql_query, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

std::string Database::max(std::string column, std::string table,
		std::string joinTable1, std::string table1_constraint,
		std::string joinTable2, std::string table2_constaint,
		std::string where_constraint, std::string& value)
{
	std::string sql_query;
	std::list<std::string> out_values;
	if (joinTable2 != "")
	{
		sql_query = "SELECT MAX(" + table + "." + column + ") FROM " + table
				+ " INNER JOIN " + joinTable1 + " ON " + table1_constraint
				+ " INNER JOIN " + joinTable2 + " ON " + table2_constaint
				+ " WHERE " + where_constraint;

	}
	else if (joinTable1 != "")
	{
		sql_query = "SELECT MAX(" + table + "." + column + ") FROM " + table
				+ " INNER JOIN " + joinTable1 + " ON " + table1_constraint
				+ " WHERE " + where_constraint;
	}
	else
	{
		sql_query = "SELECT MAX(" + table + "." + column + ") FROM " + table
				+ " WHERE " + where_constraint;

	}
	query(sql_query, out_values);
	value = *out_values.begin();

	return (value);
}

int Database::get_where(std::string table, std::string thecolumn,
		std::string where_constraint, std::list<std::string>& out_values)
{
	std::string sql_query = "SELECT " + thecolumn + " FROM " + table + " WHERE "
			+ where_constraint + ";";

	query(sql_query, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::join(std::string column, std::string table,
		std::string joinTable1, std::string table1_constraint,
		std::string joinTable2, std::string table2_constaint,
		std::string where_constraint, std::list<std::string>& out_values)
{

	//SELECT Packets.seq, Packets.traceID, Packets.flowID FROM Packets
	//	INNER JOIN Flows ON (Flows.flowID=Packets.flowID) AND (Flows.traceID=Packets.traceID)
	//	INNER JOIN Traces ON Traces.traceID=Flows.traceID
	//	WHERE (Flows.flowID=0 AND Traces.traceName="arboc" );

	std::string sql_query;
	if (joinTable2 != "")
	{
		sql_query = "SELECT " + table + "." + column + " FROM " + table
				+ " INNER JOIN " + joinTable1 + " ON " + table1_constraint
				+ " INNER JOIN " + joinTable2 + " ON " + table2_constaint
				+ " WHERE " + where_constraint;

	}
	else if (joinTable1 != "")
	{
		sql_query = "SELECT " + table + "." + column + " FROM " + table
				+ " INNER JOIN " + joinTable1 + " ON " + table1_constraint
				+ " WHERE " + where_constraint;
	}
	else
	{
		sql_query = "SELECT " + table + "." + column + " FROM " + table
				+ " WHERE " + where_constraint;

	}
	query(sql_query, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::get(std::string table, std::string thecolumn,
		std::list<double>& out_values)
{
	std::list<std::string> out_str;

	get(table, thecolumn, out_str);
	string_to_double(out_str, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::get_where(std::string table, std::string thecolumn,
		std::string where_constraint, std::list<double>& out_values)
{
	std::list<std::string> out_str;

	get_where(table, thecolumn, where_constraint, out_str);
	string_to_double(out_str, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::join(std::string column, std::string table,
		std::string joinTable1, std::string table1_constraint,
		std::string joinTable2, std::string table2_constaint,
		std::string where_constraint, std::list<double>& out_values)
{
	std::list<std::string> out_str;

	join(column, table, joinTable1, table1_constraint, joinTable2,
			table2_constaint, where_constraint, out_str);
	string_to_double(out_str, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

double Database::max(std::string column, std::string table,
		std::string joinTable1, std::string table1_constraint,
		std::string joinTable2, std::string table2_constaint,
		std::string where_constraint, double& value)
{
	std::string out_str;

	max(column, table, joinTable1, table1_constraint, joinTable2,
			table2_constaint, where_constraint, out_str);
	value = std::stof(out_str);

	return (value);
}

int Database::get(std::string table, std::string thecolumn,
		std::list<int>& out_values)
{
	std::list<std::string> out_str;

	get(table, thecolumn, out_str);
	string_to_int(out_str, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::get_where(std::string table, std::string thecolumn,
		std::string where_constraint, std::list<int>& out_values)
{
	std::list<std::string> out_str;

	get_where(table, thecolumn, where_constraint, out_str);
	string_to_int(out_str, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::join(std::string column, std::string table,
		std::string joinTable1, std::string table1_constraint,
		std::string joinTable2, std::string table2_constaint,
		std::string where_constraint, std::list<int>& out_values)
{
	std::list<std::string> out_str;

	join(column, table, joinTable1, table1_constraint, joinTable2,
			table2_constaint, where_constraint, out_str);

	string_to_int(out_str, out_values);

	return (DATABASE_SQLITE3_SUCCSESS);
}

int Database::max(std::string column, std::string table,
		std::string joinTable1, std::string table1_constraint,
		std::string joinTable2, std::string table2_constaint,
		std::string where_constraint, int& value)
{
	std::string out_str;

	max(column, table, joinTable1, table1_constraint, joinTable2,
			table2_constaint, where_constraint, out_str);
	value = std::stoi(out_str);

	return (value);
}

void Database::string_to_int(std::list<std::string> inlist,
		std::list<int>& outlist)
{

	for (std::list<std::string>::iterator it = inlist.begin();
			it != inlist.end(); it++)
	{
		outlist.push_back(std::stoi(*it));
	}
}

void Database::string_to_double(std::list<std::string> inlist,
		std::list<double>& outlist)
{
	for (std::list<std::string>::iterator it = inlist.begin();
			it != inlist.end(); it++)
	{
		outlist.push_back(std::stof(*it));
	}
}

void Database::error_cant_open()
{
	fprintf(stderr, "DatabaseSqlite3 Error: Can't open database: %s\n",
			sqlite3_errmsg(m_db));
	sqlite3_close(m_db);
	exit(DATABASE_SQLITE3_CANT_OPEN);
}

void Database::error_failed_to_fetch()
{
	fprintf(stderr, "DatabaseSqlite3 Error: Failed to fetch data: %s\n",
			sqlite3_errmsg(m_db));
	sqlite3_close(m_db);
	exit(DATABASE_FAILED_FETCH_DATA);
}

void Database::error_table_not_found()
{
	fprintf(stderr, "DatabaseSqlite3 Error: Table not found: %s\n",
			sqlite3_errmsg(m_db));
	sqlite3_close(m_db);
	exit(DATABASE_TABLE_NOT_FOUND);
}

void Database::error_column_not_found()
{
	fprintf(stderr, "DatabaseSqlite3 Error: Column not found: %s\n",
			sqlite3_errmsg(m_db));
	sqlite3_close(m_db);
	exit(DATABASE_COLUMN_NOT_FOUND);
}
